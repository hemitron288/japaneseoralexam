<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>日語入門口譯 模擬口試 (修正版)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&family=Noto+Sans+JP:wght@400;500;700&family=Noto+Sans+TC:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', 'Noto Sans TC', sans-serif;
        }
        .jp-text {
            font-family: 'Noto Sans JP', sans-serif;
        }
        [data-step] {
            display: none;
        }
        [data-step].active {
            display: block;
        }
        .loader {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3498db;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        ruby {
            ruby-position: over;
        }
        rt, rp {
            font-size: 0.6em;
            color: #4a5568;
            user-select: none;
        }
        .clickable-sentence {
            cursor: pointer;
            transition: background-color 0.2s;
            border-radius: 4px;
            padding: 2px 4px;
        }
        .clickable-sentence:hover {
            background-color: #e0f2fe;
        }
    </style>
</head>
<body class="bg-gray-100 text-gray-800">

    <div class="container mx-auto p-4 sm:p-6 md:p-8 max-w-4xl">
        <header class="text-center mb-6">
            <h1 class="text-2xl sm:text-3xl font-bold text-sky-800">HKU SPACE 日語入門口譯</h1>
            <h2 class="text-xl sm:text-2xl font-semibold text-sky-700">模擬口試系統 (修正版)</h2>
        </header>

        <!-- Progress Bar -->
        <div class="w-full bg-gray-200 rounded-full h-2.5 mb-6">
            <div id="progress-bar" class="bg-sky-600 h-2.5 rounded-full" style="width: 0%"></div>
        </div>

        <main id="exam-container" class="bg-white p-6 sm:p-8 rounded-2xl shadow-lg">

            <!-- Step 1: Introduction -->
            <div id="step-1" data-step class="active">
                <h3 class="text-2xl font-bold mb-4 text-gray-700">口試須知</h3>
                <div class="space-y-3 text-gray-600">
                    <p>1. 本模擬口試將完整模擬正式考試流程。</p>
                    <p>2. 考試流程分為：<strong class="text-sky-700">文章朗讀</strong>、<strong class="text-sky-700">文章問答</strong> 及 <strong class="text-sky-700">個人問題</strong>。</p>
                    <p>3. 系統將根據<strong class="text-sky-700">標準評分模式</strong>為您的表現評分。</p>
                    <p>4. 請允許瀏覽器使用麥克風權限以進行錄音。</p>
                </div>
                 <div class="mt-6">
                    <label for="user-name" class="block text-sm font-medium text-gray-700">請輸入您的姓名：</label>
                    <input type="text" id="user-name" value="ティム" class="mt-1 block w-full jp-text p-2 border border-gray-300 rounded-md shadow-sm focus:ring-sky-500 focus:border-sky-500">
                </div>
                <div id="compatibility-check" class="mt-6 p-4 bg-red-100 text-red-700 rounded-lg hidden">
                    您的瀏覽器不支援語音辨識功能，建議使用最新版本的 Chrome 或 Edge 瀏覽器。
                </div>
                <button id="start-exam-btn" class="mt-8 w-full bg-sky-600 text-white font-bold py-3 px-6 rounded-lg hover:bg-sky-700 transition-colors duration-300 focus:outline-none focus:ring-2 focus:ring-sky-500 focus:ring-opacity-50">
                    我已了解，開始考試
                </button>
            </div>

            <!-- Step 2: Reading Aloud -->
            <div id="step-2" data-step>
                <h3 class="text-2xl font-bold mb-2 text-gray-700">第一部分：文章朗讀 (30秒)</h3>
                <p class="text-gray-500 mb-4">請朗讀以下文章。點擊單一句子可單獨播放。點擊「播放全文」可聽取電腦朗讀。</p>
                <div id="reading-article-container" class="p-4 border rounded-lg bg-gray-50 mb-4">
                    <h4 id="article-title" class="text-xl font-semibold mb-2 jp-text"></h4>
                    <div id="article-content" class="text-lg leading-relaxed jp-text"></div>
                </div>
                <div class="flex items-center justify-between mb-4 flex-wrap gap-2">
                     <div class="flex gap-2">
                         <button id="play-article-btn" class="bg-blue-500 text-white font-bold py-2 px-4 rounded-lg hover:bg-blue-600 transition-colors duration-300 flex items-center">
                             <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" viewBox="0 0 20 20" fill="currentColor"><path d="M10 18a8 8 0 100-16 8 8 0 000 16zM9.555 7.168A1 1 0 008 8v4a1 1 0 001.555.832l3-2a1 1 0 000-1.664l-3-2z" /></svg>
                             播放全文
                         </button>
                          <button id="switch-article-btn" class="bg-gray-500 text-white font-bold py-2 px-4 rounded-lg hover:bg-gray-600 transition-colors duration-300 flex items-center">
                             <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M4 2a1 1 0 011 1v2.101a7.002 7.002 0 0111.601 2.566 1 1 0 11-1.885.666A5.002 5.002 0 005.999 7H9a1 1 0 110 2H4a1 1 0 01-1-1V3a1 1 0 011-1zm.008 9.057a1 1 0 011.885-.666A5.002 5.002 0 0014.001 13H11a1 1 0 110-2h5a1 1 0 011 1v5a1 1 0 11-2 0v-2.101a7.002 7.002 0 01-11.601-2.566z" clip-rule="evenodd" /></svg>
                             切換文章
                         </button>
                     </div>
                    <div id="timer" class="text-2xl font-bold text-red-500">00:30</div>
                </div>
                <button id="start-reading-btn" class="w-full bg-red-600 text-white font-bold py-3 px-6 rounded-lg hover:bg-red-700 transition-colors duration-300 flex items-center justify-center">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11a7 7 0 01-7 7m0 0a7 7 0 01-7-7m7 7v4m0 0H8m4 0h4m-4-8a3 3 0 01-3-3V5a3 3 0 116 0v6a3 3 0 01-3 3z" /></svg>
                    開始錄音
                </button>
                <div id="reading-loader" class="mt-4 hidden flex-col items-center">
                    <div class="loader"></div>
                    <p class="mt-2 text-gray-500">計時與辨識中...</p>
                </div>
                <p id="reading-transcript-display" class="mt-3 p-2 bg-gray-100 rounded-md min-h-[40px] jp-text"></p>
                <div class="mt-8 flex justify-end">
                    <button onclick="handleNavigation('next')" class="bg-sky-600 text-white font-bold py-2 px-5 rounded-lg hover:bg-sky-700">下一部分 &rarr;</button>
                </div>
            </div>

            <!-- Step 3: Article Questions -->
            <div id="step-3" data-step>
                <h3 class="text-2xl font-bold mb-2 text-gray-700">第二部分：文章問答</h3>
                <p class="text-gray-500 mb-4">請參考上方文章，回答下列問題。</p>
                <div id="article-reference-container" class="p-4 border rounded-lg bg-gray-50 mb-4">
                    <h4 id="article-reference-title" class="text-xl font-semibold mb-2 jp-text"></h4>
                    <div id="article-reference-content" class="text-base leading-relaxed jp-text text-gray-600"></div>
                </div>
                <div id="article-q-container" class="space-y-6">
                    <!-- Questions will be injected here -->
                </div>
                <div class="mt-8 flex justify-between">
                    <button onclick="handleNavigation('prev')" class="bg-gray-500 text-white font-bold py-2 px-5 rounded-lg hover:bg-gray-600">&larr; 上一部分</button>
                    <button onclick="handleNavigation('next')" class="bg-sky-600 text-white font-bold py-2 px-5 rounded-lg hover:bg-sky-700">下一部分 &rarr;</button>
                </div>
            </div>

            <!-- Step 4: Personal Questions -->
            <div id="step-4" data-step>
                <h3 class="text-2xl font-bold mb-2 text-gray-700">第三部分：個人問題</h3>
                <p class="text-gray-500 mb-4">導師將提問十題個人問題，請作答。</p>
                <div id="personal-q-container" class="space-y-6">
                    <!-- Questions will be injected here -->
                </div>
                <div class="mt-8 flex justify-between">
                    <button onclick="handleNavigation('prev')" class="bg-gray-500 text-white font-bold py-2 px-5 rounded-lg hover:bg-gray-600">&larr; 上一部分</button>
                    <button id="finish-exam-btn" class="bg-green-600 text-white font-bold py-3 px-6 rounded-lg hover:bg-green-700">完成考試，查看結果</button>
                </div>
            </div>

            <!-- Step 5: Results -->
            <div id="step-5" data-step>
                <h3 class="text-2xl font-bold mb-4 text-gray-700">評分報告</h3>
                <div id="results-loader" class="hidden flex-col items-center my-8">
                    <div class="loader"></div>
                    <p class="mt-4 text-gray-600 text-lg">正在為您評分，請稍候...</p>
                </div>
                <div id="results-content">
                    <div id="results-summary" class="mb-6 p-4 bg-sky-100 rounded-lg text-center">
                        <p class="text-lg">總分</p>
                        <p id="total-score" class="text-5xl font-bold text-sky-700"></p>
                    </div>
                    <div id="results-details" class="space-y-6">
                        <!-- Detailed results will be injected here -->
                    </div>
                    <button id="restart-exam-btn" class="mt-8 w-full bg-gray-600 text-white font-bold py-3 px-6 rounded-lg hover:bg-gray-700 transition-colors duration-300">
                        重新開始模擬考試
                    </button>
                </div>
            </div>
        </main>
    </div>

    <script>
        // --- DATA ---
        const articles = {
            A: {
                title: '旅行 (サントス)',
                content: [
                    '<ruby>去年<rp>(</rp><rt>きょねん</rt><rp>)</rp></ruby>の<ruby>冬<rp>(</rp><rt>ふゆ</rt><rp>)</rp></ruby>、わたしは<ruby>家族<rp>(</rp><rt>かぞく</rt><rp>)</rp></ruby>と<ruby>北海道<rp>(</rp><rt>ほっかいどう</rt><rp>)</rp></ruby>へスキーに<ruby>行<rp>(</rp><rt>い</rt><rp>)</rp></ruby>きました。',
                    '<ruby>北海道<rp>(</rp><rt>ほっかいどう</rt><rp>)</rp></ruby>は<ruby>毎日<rp>(</rp><rt>まいにち</rt><rp>)</rp></ruby><ruby>雪<rp>(</rp><rt>ゆき</rt><rp>)</rp></ruby>が<ruby>降<rp>(</rp><rt>ふ</rt><rp>)</rp></ruby>っていました。',
                    '<ruby>北海道<rp>(</rp><rt>ほっかいどう</rt><rp>)</rp></ruby>へ3<ruby>回<rp>(</rp><rt>かい</rt><rp>)</rp></ruby><ruby>行<rp>(</rp><rt>い</rt><rp>)</rp></ruby>ったことがありますが、<ruby>冬<rp>(</rp><rt>ふゆ</rt><rp>)</rp></ruby>は<ruby>初<rp>(</rp><rt>はじ</rt><rp>)</rp></ruby>めてです。',
                    'スキーもしたことがありません。',
                    '1<ruby>週間<rp>(</rp><rt>しゅうかん</rt><rp>)</rp></ruby><ruby>毎日<rp>(</rp><rt>まいにち</rt><rp>)</rp></ruby>スキーを<ruby>練習<rp>(</rp><rt>れんしゅう</rt><rp>)</rp></ruby>しましたが、なかなか<ruby>上手<rp>(</rp><rt>じょうず</rt><rp>)</rp></ruby>になりませんでした。',
                    '<ruby>短<rp>(</rp><rt>みじか</rt><rp>)</rp></ruby>い<ruby>旅行<rp>(</rp><rt>りょこう</rt><rp>)</rp></ruby>でしたが、おいしい<ruby>料理<rp>(</rp><rt>りょうり</rt><rp>)</rp></ruby>を<ruby>食<rp>(</rp><rt>た</rt><rp>)</rp></ruby>べたり、<ruby>買<rp>(</rp><rt>か</rt><rp>)</rp></ruby>い<ruby>物<rp>(</rp><rt>もの</rt><rp>)</rp></ruby>したりしました。',
                    'とても<ruby>楽<rp>(</rp><rt>たの</rt><rp>)</rp></ruby>しかったです。',
                    'ぜひまた<ruby>北海道<rp>(</rp><rt>ほっかいどう</rt><rp>)</rp></ruby>へ<ruby>行<rp>(</rp><rt>い</rt><rp>)</rp></ruby>きたいです。'
                ],
                questions: [
                    'サントスさんはいつ北海道へ行きましたか。',
                    'サントスさんは何回スキーをしたことがありますか。',
                    '旅行で何をしましたか。'
                ]
            },
            B: {
                title: '週末 (サントス)',
                content: [
                    'わたしは<ruby>先週<rp>(</rp><rt>せんしゅう</rt><rp>)</rp></ruby>の<ruby>土曜日<rp>(</rp><rt>どようび</rt><rp>)</rp></ruby>、<ruby>友達<rp>(</rp><rt>ともだち</rt><rp>)</rp></ruby>の<ruby>田中<rp>(</rp><rt>たなか</rt><rp>)</rp></ruby>さんのおうちへ<ruby>遊<rp>(</rp><rt>あそ</rt><rp>)</rp></ruby>びに<ruby>行<rp>(</rp><rt>い</rt><rp>)</rp></ruby>きました。',
                    '<ruby>田中<rp>(</rp><rt>たなか</rt><rp>)</rp></ruby>さんの<ruby>家族<rp>(</rp><rt>かぞく</rt><rp>)</rp></ruby>は3<ruby>人<rp>(</rp><rt>にん</rt><rp>)</rp></ruby>です。',
                    '<ruby>田中<rp>(</rp><rt>たなか</rt><rp>)</rp></ruby>さん<ruby>母親<rp>(</rp><rt>ははおや</rt><rp>)</rp></ruby>と<ruby>子<rp>(</rp><rt>こ</rt><rp>)</rp></ruby>どもが1<ruby>人<rp>(</rp><rt>り</rt><rp>)</rp></ruby>います。',
                    '<ruby>土曜日<rp>(</rp><rt>どようび</rt><rp>)</rp></ruby>の<ruby>夜<rp>(</rp><rt>よる</rt><rp>)</rp></ruby>、いっしょに<ruby>日本<rp>(</rp><rt>にほん</rt><rp>)</rp></ruby><ruby>料理<rp>(</rp><rt>りょうり</rt><rp>)</rp></ruby>を<ruby>作<rp>(</rp><rt>つく</rt><rp>)</rp></ruby>って、<ruby>食<rp>(</rp><rt>た</rt><rp>)</rp></ruby>べました。',
                    'ごはんを<ruby>食<rp>(</rp><rt>た</rt><rp>)</rp></ruby>べてから、<ruby>歌<rp>(</rp><rt>うた</rt><rp>)</rp></ruby>を<ruby>歌<rp>(</rp><rt>うた</rt><rp>)</rp></ruby>ったり、ゲームで<ruby>遊<rp>(</rp><rt>あそ</rt><rp>)</rp></ruby>んだりしました。',
                    '<ruby>日曜日<rp>(</rp><rt>にちようび</rt><rp>)</rp></ruby>、わたしたちは<ruby>海<rp>(</rp><rt>うみ</rt><rp>)</rp></ruby>へ<ruby>行<rp>(</rp><rt>い</rt><rp>)</rp></ruby>きました。',
                    '<ruby>週末<rp>(</rp><rt>しゅうまつ</rt><rp>)</rp></ruby>でしたから、<ruby>人<rp>(</rp><rt>ひと</rt><rp>)</rp></ruby>がたくさんいました。',
                    '<ruby>昼<rp>(</rp><rt>ひる</rt><rp>)</rp></ruby>ごはんはドイツ<ruby>料理<rp>(</rp><rt>りょうり</rt><rp>)</rp></ruby>のレストランで<ruby>食<rp>(</rp><rt>た</rt><rp>)</rp></ruby>べました。',
                    'おいしい<ruby>料理<rp>(</rp><rt>りょうり</rt><rp>)</rp></ruby>をたくさん<ruby>食<rp>(</rp><rt>た</rt><rp>)</rp></ruby>べて、おなかがいっぱいになりました。'
                ],
                questions: [
                    'サントスさんは先週の土曜日、どこへ行きましたか。',
                    '田中さんの家族は何人ですか。',
                    '日曜日にどこで昼ごはんを食べましたか。'
                ]
            },
            C: {
                title: '趣味 (サントス)',
                content: [
                    'わたしの<ruby>趣味<rp>(</rp><rt>しゅみ</rt><rp>)</rp></ruby>は<ruby>映画<rp>(</rp><rt>えいが</rt><rp>)</rp></ruby>を<ruby>見<rp>(</rp><rt>み</rt><rp>)</rp></ruby>ることです。',
                    '<ruby>週末<rp>(</rp><rt>しゅうまつ</rt><rp>)</rp></ruby>はうちで<ruby>日本<rp>(</rp><rt>にほん</rt><rp>)</rp></ruby><ruby>映画<rp>(</rp><rt>えいが</rt><rp>)</rp></ruby>や<ruby>香港<rp>(</rp><rt>ほんこん</rt><rp>)</rp></ruby><ruby>映画<rp>(</rp><rt>えいが</rt><rp>)</rp></ruby>のDVDを<ruby>見<rp>(</rp><rt>み</rp><rp>)</rp></ruby>ます。',
                    '<ruby>今<rp>(</rp><rt>いま</rp><rp>)</rp></ruby>、わたしはDVDを200<ruby>枚<rp>(</rp><rt>まい</rt><rp>)</rp></ruby>ぐらい<ruby>持<rp>(</rp><rt>も</rt><rp>)</rp></ruby>っています。',
                    'わたしは<ruby>香港<rp>(</rp><rt>ほんこん</rt><rp>)</rp></ruby><ruby>映画<rp>(</rp><rt>えいが</rt><rp>)</rp></ruby>より<ruby>日本<rp>(</rp><rt>にほん</rt><rp>)</rp></ruby><ruby>映画<rp>(</rp><rt>えいが</rt><rp>)</rp></ruby>のほうが<ruby>好<rp>(</rp><rt>す</rt><rp>)</rp></ruby>きですから、<ruby>日本<rp>(</rp><rt>にほん</rt><rp>)</rp></ruby><ruby>映画<rp>(</rp><rt>えいが</rt><rp>)</rp></ruby>のDVDがたくさんあります。',
                    '<ruby>日本<rp>(</rp><rt>にほん</rt><rp>)</rp></ruby><ruby>映画<rp>(</rp><rt>えいが</rt><rp>)</rp></ruby>はおもしろいですから、<ruby>映画<rp>(</rp><rt>えいが</rt><rp>)</rp></ruby>で<ruby>日本語<rp>(</rp><rt>にほんご</rt><rp>)</rp></ruby>を<ruby>勉強<rp>(</rp><rt>べんきょう</rt><rp>)</rp></ruby>します。',
                    '<ruby>日本語<rp>(</rp><rt>にほんご</rt><rp>)</rp></ruby>が<ruby>少<rp>(</rp><rt>すこ</rt><rp>)</rp></ruby>し<ruby>上手<rp>(</rp><rt>じょうず</rt><rp>)</rp></ruby>になりましたから、<ruby>日本<rp>(</rp><rt>にほん</rt><rp>)</rp></ruby>へ<ruby>行<rp>(</rp><rt>い</rt><rp>)</rp></ruby>って、<ruby>日本人<rp>(</rp><rt>にほんじん</rt><rp>)</rp></ruby>と<ruby>話<rp>(</rp><rt>はな</rt><rp>)</rp></ruby>したい、<ruby>日本<rp>(</rp><rt>にほん</rt><rp>)</rp></ruby>で<ruby>映画<rp>(</rp><rt>えいが</rt><rp>)</rp></ruby>を<ruby>見<rp>(</rp><rt>み</rt><rp>)</rp></ruby>たいです。'
                ],
                questions: [
                    'サントスさんの趣味は何ですか。',
                    'サントスさんはDVDを何枚ぐらい持っていますか。',
                    'どうしてサントスさんは映画で日本語を勉強しますか。'
                ]
            }
        };

        const personalQuestions = [
            '〜さんは学生/会社員ですか。', '〜さんのうちはどちらですか。', '〜さんの誕生日はいつですか。', '〜さんの休みは何曜日/いつですか。', 'どこへ/何で/何時に/いつ/誰と/どうやって行きましたか。', '週末/日曜日/いつも 何を しますか/しましたか。', 'どこで食べましたか。', '今年/去年の誕生日にプレゼントをもらいましたか。', '飛行機の切符をあげます。どこへ何をしに行きますか。', '仕事/学校は忙しいですか。', '〜はどんなところですか。', '〜はどうですか。', 'どうしてですか。', 'けさ何か食べましたか。', '〜さんは〜が好きですか。', 'どんな〜が好き/嫌いですか。(例 どんな映画が好きですか。)', '〜さんのうちに犬がいますか。', 'どのくらいかかりましたか。どのくらい行きましたか。', '〜さんは〜が いくつ/何枚/何台/何合いありますか。', '1年/1か月/1週間に何回ぐらい 〜か。', '今までのぐらい日本語を勉強しましたか。', '〜さんの家族は何人ですか。', '〜と〜どちらが好きですか。(例 犬と猫どちらが好きですか。)', '家族でだれがいちばん料理が上手ですか。', '〜さんは季節/1年でいつがいちばん好きですか。', '先週は忙しかったですか。', '〜はどうでしたか。', '〜の天気はどうでしたか。', '今何がいちばん欲しいですか。', '兄弟がいますか。', 'この週末は何をしたいですか。', '今/夏休みに/何をいちばんしたいですか。', 'どこか旅行に行きましたか。', 'この漢字の読み方を教えてください。', '今雨が降っていますか。', '日本でいちばん高い山を知っていますか。', '〜さんは働いていますか。', 'けさ起きてから、何をしましたか。', 'この試験が終わってから、何をしますか。', '〇〇をしてから、何をしますか。(例 休みの日は何をしますか。それから、〇〇をしてから、何をしますか。)', '〇〇をしてから、何をしたいですか。(例 日本へ行って、何をしたいですか。〇〇してから、何をしたいですか。)', '〇〇をしてから、何をしましたか。(例 映画を見てから、何をしましたか。)', '〜さんのうちから空港までどうやって行きますか。', '海外旅行に何を持って行かなければなりませんか。', '日曜日も働かなければなりませんか。/日曜日仕事がなくてもいいですか。', '〜さんの趣味は何ですか。', '〜さんは〜ができますか。/〜さんは〜することができますか。', '〜さんは次の誕生日に何をしたいですか。', '〜ことがありますか。', '毎晩寝るまえに、何をしますか。'
        ];

        // --- STATE ---
        let currentStep = 1;
        let currentArticleIndex = 0;
        let userName = 'ティム';
        let selectedArticleKey;
        let selectedArticle;
        let readingTranscript = '';
        let articleQuestionTranscripts = [];
        let personalQuestionTranscripts = [];
        let selectedPersonalQuestions = [];
        let timerInterval;
        let examResults = {};
        let isReadingAloud = false;

        // --- SPEECH API ---
        const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
        let recognition;
        let isCompatible = !!SpeechRecognition;

        if (isCompatible) {
            recognition = new SpeechRecognition();
            recognition.continuous = true;
            recognition.lang = 'ja-JP';
            recognition.interimResults = true;
        }

        // --- DOM ELEMENTS ---
        const progressBar = document.getElementById('progress-bar');
        const steps = document.querySelectorAll('[data-step]');
        const startExamBtn = document.getElementById('start-exam-btn');
        const compatibilityCheck = document.getElementById('compatibility-check');
        const userNameInput = document.getElementById('user-name');
        
        const articleTitle = document.getElementById('article-title');
        const articleContent = document.getElementById('article-content');
        const playArticleBtn = document.getElementById('play-article-btn');
        const switchArticleBtn = document.getElementById('switch-article-btn');
        const startReadingBtn = document.getElementById('start-reading-btn');
        const timerEl = document.getElementById('timer');
        const readingLoader = document.getElementById('reading-loader');
        const readingTranscriptDisplay = document.getElementById('reading-transcript-display');

        const articleReferenceContainer = document.getElementById('article-reference-container');
        const articleReferenceTitle = document.getElementById('article-reference-title');
        const articleReferenceContent = document.getElementById('article-reference-content');
        const articleQContainer = document.getElementById('article-q-container');

        const personalQContainer = document.getElementById('personal-q-container');
        
        const finishExamBtn = document.getElementById('finish-exam-btn');
        const resultsLoader = document.getElementById('results-loader');
        const resultsContent = document.getElementById('results-content');
        const totalScoreEl = document.getElementById('total-score');
        const resultsDetails = document.getElementById('results-details');
        const restartExamBtn = document.getElementById('restart-exam-btn');

        // --- FUNCTIONS ---
        
        function updateProgress() {
            const progressPercentage = ((currentStep - 1) / 4) * 100;
            progressBar.style.width = `${progressPercentage}%`;
        }

        function handleNavigation(direction) {
            if (direction === 'next' && currentStep < 5) {
                goToStep(currentStep + 1);
            } else if (direction === 'prev' && currentStep > 1) {
                goToStep(currentStep - 1);
            }
        }

        function goToStep(stepNumber) {
            // BUG FIX: Removed the faulty guard clause that prevented navigation to step 5.
            // The original line was: if (stepNumber > 4 && currentStep <= 4) return;
            
            currentStep = stepNumber;
            steps.forEach(step => {
                if (parseInt(step.id.split('-')[1]) === currentStep) {
                    step.classList.add('active');
                } else {
                    step.classList.remove('active');
                }
            });

            if (currentStep === 3) {
                articleReferenceTitle.innerHTML = selectedArticle.title;
                articleReferenceContent.innerHTML = selectedArticle.content.join(' ');
            }
            if(currentStep === 4) {
                renderPersonalQuestions();
            }

            updateProgress();
        }

        function speak(text, lang = 'ja-JP') {
            if ('speechSynthesis' in window) {
                window.speechSynthesis.cancel();
                // Clean up text by removing furigana for accurate pronunciation
                const tempDiv = document.createElement('div');
                tempDiv.innerHTML = text;
                const clone = tempDiv.cloneNode(true);
                clone.querySelectorAll('rt, rp').forEach(el => el.remove());
                const cleanText = clone.textContent || clone.innerText || '';

                const utterance = new SpeechSynthesisUtterance(cleanText);
                utterance.lang = lang;
                utterance.rate = 0.9;
                window.speechSynthesis.speak(utterance);
            } else {
                // Use a custom modal or inline message instead of alert
                console.error('抱歉，您的瀏覽器不支援語音合成功能。');
            }
        }

        function startRecognition(onResultCallback, onEndCallback) {
            if (!isCompatible) return;
            try {
                recognition.abort(); // Stop any previous recognition
            } catch(e) { /* Ignore if not started */ }
            
            let finalTranscript = '';
            recognition.onresult = (event) => {
                let interimTranscript = '';
                for (let i = event.resultIndex; i < event.results.length; ++i) {
                    if (event.results[i].isFinal) {
                        finalTranscript += event.results[i][0].transcript;
                    } else {
                        interimTranscript += event.results[i][0].transcript;
                    }
                }
                onResultCallback(finalTranscript + interimTranscript);
            };
            recognition.onend = () => {
                onEndCallback(finalTranscript);
            };
            recognition.start();
        }

        function stopRecognition() {
            if (recognition) {
                recognition.stop();
            }
        }

        function shuffleArray(array) {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
            return array;
        }
        
        function renderArticle() {
            articleTitle.innerHTML = selectedArticle.title;
            articleContent.innerHTML = '';
            selectedArticle.content.forEach(sentenceHTML => {
                const sentenceEl = document.createElement('span');
                sentenceEl.innerHTML = sentenceHTML;
                sentenceEl.className = 'clickable-sentence';
                sentenceEl.onclick = () => speak(sentenceHTML);
                articleContent.appendChild(sentenceEl);
                articleContent.appendChild(document.createTextNode(' '));
            });
        }

        function switchArticle() {
            const articleKeys = Object.keys(articles);
            currentArticleIndex = (currentArticleIndex + 1) % articleKeys.length;
            selectedArticleKey = articleKeys[currentArticleIndex];
            selectedArticle = articles[selectedArticleKey];
            renderArticle();
            updateArticleQuestions();
        }
        
        function updateArticleQuestions() {
            articleQContainer.innerHTML = '';
            articleQuestionTranscripts = Array(selectedArticle.questions.length).fill('');
            selectedArticle.questions.forEach((q, index) => {
                articleQContainer.innerHTML += createQuestionHTML(q, index, 'article');
            });
        }
        
        function renderPersonalQuestions() {
            personalQContainer.innerHTML = '';
            selectedPersonalQuestions.forEach((q, index) => {
                personalQContainer.innerHTML += createQuestionHTML(q, index, 'personal');
            });
        }

        function initExam() {
            currentStep = 1;
            currentArticleIndex = 0;
            userName = 'ティム';
            userNameInput.value = userName;
            readingTranscript = '';
            articleQuestionTranscripts = [];
            personalQuestionTranscripts = [];
            examResults = {};
            if (timerInterval) clearInterval(timerInterval);

            const articleKeys = Object.keys(articles);
            selectedArticleKey = articleKeys[currentArticleIndex];
            selectedArticle = articles[selectedArticleKey];

            renderArticle();
            updateArticleQuestions();
            
            selectedPersonalQuestions = shuffleArray([...personalQuestions]).slice(0, 10);
            personalQuestionTranscripts = Array(10).fill('');
            renderPersonalQuestions();

            timerEl.textContent = '00:30';
            startReadingBtn.disabled = false;
            readingLoader.classList.add('hidden');
            readingTranscriptDisplay.textContent = '';
            
            resultsLoader.classList.add('hidden');
            resultsContent.style.display = 'none'; // Hide results until calculated

            goToStep(1);
        }

        function createQuestionHTML(question, index, type) {
            let processedQuestion = question.replace(/〜さん/g, `${userName}さん`);
            
            return `
                <div class="p-4 border rounded-lg">
                    <p class="jp-text text-lg mb-3"><strong>問題 ${index + 1}:</strong> ${processedQuestion}</p>
                    <div class="flex flex-col sm:flex-row gap-2">
                        <button onclick="speak('${processedQuestion.replace(/'/g, "\\'")}')" class="flex-shrink-0 bg-blue-500 text-white font-bold py-2 px-4 rounded-lg hover:bg-blue-600 transition-colors duration-300 flex items-center justify-center">
                             <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" viewBox="0 0 20 20" fill="currentColor"><path d="M10 18a8 8 0 100-16 8 8 0 000 16zM9.555 7.168A1 1 0 008 8v4a1 1 0 001.555.832l3-2a1 1 0 000-1.664l-3-2z" /></svg>
                            播放問題
                        </button>
                        <button data-recording="false" data-type="${type}" data-index="${index}" class="flex-shrink-0 bg-red-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-red-700 transition-colors duration-300 record-btn flex items-center justify-center">
                           <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11a7 7 0 01-7 7m0 0a7 7 0 01-7-7m7 7v4m0 0H8m4 0h4m-4-8a3 3 0 01-3-3V5a3 3 0 116 0v6a3 3 0 01-3 3z" /></svg>
                            開始錄音
                        </button>
                    </div>
                    <div id="${type}-loader-${index}" class="mt-2 hidden flex items-center">
                        <div class="loader !w-5 !h-5"></div>
                        <p class="ml-2 text-gray-500">辨識中...</p>
                    </div>
                    <p id="${type}-transcript-${index}" class="mt-3 p-2 bg-gray-100 rounded-md min-h-[40px] jp-text"></p>
                </div>
            `;
        }
        
        function handleQuestionRecording(btn) {
            const type = btn.dataset.type;
            const index = parseInt(btn.dataset.index);
            const isRecording = btn.dataset.recording === 'true';
            const loader = document.getElementById(`${type}-loader-${index}`);
            const transcriptEl = document.getElementById(`${type}-transcript-${index}`);
            const allRecordBtns = document.querySelectorAll('.record-btn');

            if (!isRecording) {
                // Stop all other recordings
                allRecordBtns.forEach(b => {
                    if (b.dataset.recording === 'true') {
                        stopRecognition();
                        b.dataset.recording = 'false';
                        b.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11a7 7 0 01-7 7m0 0a7 7 0 01-7-7m7 7v4m0 0H8m4 0h4m-4-8a3 3 0 01-3-3V5a3 3 0 116 0v6a3 3 0 01-3 3z" /></svg> 重新錄音`;
                        b.classList.replace('bg-yellow-500', 'bg-red-600');
                        b.classList.replace('hover:bg-yellow-600', 'hover:bg-red-700');
                        document.getElementById(`${b.dataset.type}-loader-${b.dataset.index}`).classList.add('hidden');
                    }
                    b.disabled = true;
                });
                
                btn.disabled = false;
                btn.dataset.recording = 'true';
                btn.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8 7a1 1 0 00-1 1v4a1 1 0 102 0V8a1 1 0 00-1-1zm4 0a1 1 0 00-1 1v4a1 1 0 102 0V8a1 1 0 00-1-1z" clip-rule="evenodd" /></svg> 停止錄音`;
                btn.classList.replace('bg-red-600', 'bg-yellow-500');
                btn.classList.replace('hover:bg-red-700', 'hover:bg-yellow-600');
                loader.classList.remove('hidden');
                transcriptEl.textContent = '';
                
                startRecognition(
                    (interimTranscript) => {
                        transcriptEl.textContent = interimTranscript;
                    },
                    (finalTranscript) => {
                        transcriptEl.textContent = finalTranscript || '(未辨識到語音)';
                        if (type === 'article') {
                            articleQuestionTranscripts[index] = finalTranscript;
                        } else {
                            personalQuestionTranscripts[index] = finalTranscript;
                        }
                        btn.dataset.recording = 'false';
                        btn.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11a7 7 0 01-7 7m0 0a7 7 0 01-7-7m7 7v4m0 0H8m4 0h4m-4-8a3 3 0 01-3-3V5a3 3 0 116 0v6a3 3 0 01-3 3z" /></svg> 重新錄音`;
                        btn.classList.replace('bg-yellow-500', 'bg-red-600');
                        btn.classList.replace('hover:bg-yellow-600', 'hover:bg-red-700');
                        loader.classList.add('hidden');
                        allRecordBtns.forEach(b => b.disabled = false);
                    }
                );
            } else {
                stopRecognition();
            }
        }
        
        function calculateAndDisplayResults() {
            goToStep(5);
            resultsContent.style.display = 'none';
            resultsLoader.classList.remove('hidden');

            // Simulate processing time
            setTimeout(() => {
                let totalScore = 0;
                examResults = {
                    reading: {},
                    fluency: {},
                    articleQuestions: [],
                    personalQuestions: []
                };

                // 1. Reading Score
                examResults.reading = calculateReadingScore();
                totalScore += examResults.reading.score;

                // 2. Fluency Score (Simulated)
                examResults.fluency = calculateFluencyScore();
                totalScore += examResults.fluency.score;

                // 3. Article Questions Score
                let articleQScore = 0;
                selectedArticle.questions.forEach((q, i) => {
                    const result = calculateQuestionScore(q, articleQuestionTranscripts[i], 10);
                    examResults.articleQuestions.push(result);
                    articleQScore += result.score;
                });
                totalScore += articleQScore;

                // 4. Personal Questions Score
                let personalQScore = 0;
                selectedPersonalQuestions.forEach((q, i) => {
                    const result = calculateQuestionScore(q, personalQuestionTranscripts[i], 5);
                    examResults.personalQuestions.push(result);
                    personalQScore += result.score;
                });
                totalScore += personalQScore;

                // Display Results
                resultsDetails.innerHTML = '';
                resultsDetails.innerHTML += createResultCard('朗讀', examResults.reading.score, 10, examResults.reading.feedback, `您的朗讀稿：<br><span class="jp-text">${readingTranscript || '無'}</span>`);
                resultsDetails.innerHTML += createResultCard('口譯流暢度 (模擬)', examResults.fluency.score, 10, examResults.fluency.feedback);
                
                let articleQDetails = examResults.articleQuestions.map((r, i) => createQuestionDetailHTML(selectedArticle.questions[i], articleQuestionTranscripts[i], r, 10)).join('');
                resultsDetails.innerHTML += createResultCard('文章問答', articleQScore, 30, '根據回答的完整度評分。', articleQDetails);

                let personalQDetails = examResults.personalQuestions.map((r, i) => createQuestionDetailHTML(selectedPersonalQuestions[i], personalQuestionTranscripts[i], r, 5)).join('');
                resultsDetails.innerHTML += createResultCard('個人問題', personalQScore, 50, '根據回答的完整度評分。', personalQDetails);

                totalScoreEl.textContent = `${totalScore} / 100`;
                resultsLoader.classList.add('hidden');
                resultsContent.style.display = 'block';
            }, 500); 
        }

        function calculateReadingScore() {
            const tempDiv = document.createElement('div');
            tempDiv.innerHTML = selectedArticle.content.join(' ');
            const cleanOriginalText = (tempDiv.textContent || '').replace(/\s/g, '');
            const cleanTranscript = (readingTranscript || '').replace(/\s/g, '');
            
            if (!cleanTranscript) return { score: 0, feedback: '未偵測到朗讀內容。' };

            const similarity = stringSimilarity(cleanOriginalText, cleanTranscript);
            if (similarity > 0.8) return { score: 10, feedback: '發音非常準確，清晰，明瞭。' };
            if (similarity > 0.6) return { score: 8, feedback: '發音比較準確、清晰。' };
            if (similarity > 0.4) return { score: 6, feedback: '發音有一點不正確。' };
            if (similarity > 0.2) return { score: 4, feedback: '發音不準確，有比較多的錯誤。' };
            return { score: 2, feedback: '發音非常不正確。' };
        }

        function calculateFluencyScore() {
            const wordsPerSecond = (readingTranscript || '').split(' ').length / 30;
            let score, feedback;
            // This is a very basic simulation based on speaking rate.
            if (wordsPerSecond > 2.5) { score = 10; feedback = '語速適中，非常流暢。'; }
            else if (wordsPerSecond > 1.5) { score = 8, feedback = '語速稍慢，但比較流暢。'; }
            else if (wordsPerSecond > 0.5) { score = 6, feedback = '語速較慢，有一些停頓。'; }
            else if (wordsPerSecond > 0) { score = 4, feedback = '語速過慢，有明顯停頓。'; }
            else { score = 0, feedback = '未能偵測到流暢度。'; }
            return { score, feedback };
        }

        function calculateQuestionScore(question, transcript, maxScore) {
            const words = (transcript || '').split(' ').filter(w => w.length > 0);
            let score = 0;
            let feedback = '';

            if (!transcript || transcript === '(未辨識到語音)') {
                score = 0;
                feedback = '未能回答問題。';
            } else if (words.length <= 2) {
                score = Math.round(maxScore * 0.4);
                feedback = '以不完整句子或單詞回答。';
            } else if (words.length <= 4) {
                score = Math.round(maxScore * 0.6);
                feedback = '以句子回答，但可能不夠完整。';
            } else if (words.length <= 7) {
                score = Math.round(maxScore * 0.8);
                feedback = '以幾乎完整的句子回答。';
            } else {
                score = maxScore;
                feedback = '以完整句子回答，內容詳盡。';
            }
            return { score, feedback };
        }
        
        function stringSimilarity(s1, s2) {
            let longer = s1 || '';
            let shorter = s2 || '';
            if (s1.length < s2.length) { longer = s2; shorter = s1; }
            let longerLength = longer.length;
            if (longerLength === 0) return 1.0;
            return (longerLength - editDistance(longer, shorter)) / parseFloat(longerLength);
        }

        function editDistance(s1, s2) {
            s1 = s1.toLowerCase(); s2 = s2.toLowerCase();
            const costs = [];
            for (let i = 0; i <= s1.length; i++) {
                let lastValue = i;
                for (let j = 0; j <= s2.length; j++) {
                    if (i === 0) costs[j] = j;
                    else if (j > 0) {
                        let newValue = costs[j - 1];
                        if (s1.charAt(i - 1) !== s2.charAt(j - 1))
                            newValue = Math.min(Math.min(newValue, lastValue), costs[j]) + 1;
                        costs[j - 1] = lastValue;
                        lastValue = newValue;
                    }
                }
                if (i > 0) costs[s2.length] = lastValue;
            }
            return costs[s2.length];
        }

        function createResultCard(title, score, maxScore, feedback, details = '') {
            return `
                <div class="p-4 border rounded-lg shadow-sm">
                    <div class="flex justify-between items-center">
                        <h4 class="text-xl font-bold text-gray-700">${title}</h4>
                        <p class="text-2xl font-bold text-sky-600">${score} <span class="text-lg text-gray-500">/ ${maxScore}</span></p>
                    </div>
                    <p class="mt-2 text-gray-600"><strong>評語:</strong> ${feedback}</p>
                    ${details ? `<div class="mt-3 pt-3 border-t text-sm text-gray-700">${details}</div>` : ''}
                </div>
            `;
        }
        
        function createQuestionDetailHTML(question, transcript, result, maxScore) {
             return `<div class="mt-2 p-2 bg-gray-50 rounded"><p class="jp-text text-gray-500">問題: ${question.replace(/〜さん/g, `${userName}さん`)}</p><p class="jp-text">您的回答: ${transcript || '無'}</p><p class="font-semibold">評分: ${result.score}/${maxScore} (${result.feedback})</p></div>`;
        }

        // --- EVENT LISTENERS ---
        window.addEventListener('load', () => {
            if (!isCompatible) {
                compatibilityCheck.classList.remove('hidden');
                startExamBtn.disabled = true;
            }
            initExam();
        });

        userNameInput.addEventListener('input', (e) => {
            userName = e.target.value.trim() || 'ティム';
        });

        startExamBtn.addEventListener('click', () => {
            goToStep(2);
        });

        playArticleBtn.addEventListener('click', () => {
            speak(selectedArticle.content.join(' '));
        });

        switchArticleBtn.addEventListener('click', switchArticle);

        startReadingBtn.addEventListener('click', () => {
            if (isReadingAloud) {
                clearInterval(timerInterval);
                stopRecognition();
            } else {
                isReadingAloud = true;
                startReadingBtn.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8 7a1 1 0 00-1 1v4a1 1 0 102 0V8a1 1 0 00-1-1zm4 0a1 1 0 00-1 1v4a1 1 0 102 0V8a1 1 0 00-1-1z" clip-rule="evenodd" /></svg> 停止錄音`;
                startReadingBtn.classList.replace('bg-red-600', 'bg-yellow-500');
                startReadingBtn.classList.replace('hover:bg-red-700', 'hover:bg-yellow-600');
                readingLoader.classList.remove('hidden');
                let timeLeft = 30;
                
                timerInterval = setInterval(() => {
                    timeLeft--;
                    timerEl.textContent = `00:${timeLeft.toString().padStart(2, '0')}`;
                    if (timeLeft <= 0) {
                        clearInterval(timerInterval);
                        stopRecognition();
                    }
                }, 1000);

                startRecognition(
                    (interimTranscript) => {
                        readingTranscriptDisplay.textContent = interimTranscript;
                    },
                    (finalTranscript) => {
                        isReadingAloud = false;
                        readingTranscript = finalTranscript;
                        clearInterval(timerInterval);
                        startReadingBtn.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11a7 7 0 01-7 7m0 0a7 7 0 01-7-7m7 7v4m0 0H8m4 0h4m-4-8a3 3 0 01-3-3V5a3 3 0 116 0v6a3 3 0 01-3 3z" /></svg> 重新開始錄音`;
                        startReadingBtn.classList.replace('bg-yellow-500', 'bg-red-600');
                        startReadingBtn.classList.replace('hover:bg-yellow-600', 'hover:bg-red-700');
                        readingLoader.classList.add('hidden');
                    }
                );
            }
        });

        document.body.addEventListener('click', (e) => {
            const target = e.target.closest('.record-btn');
            if (target) {
                handleQuestionRecording(target);
            }
        });
        
        finishExamBtn.addEventListener('click', calculateAndDisplayResults);

        restartExamBtn.addEventListener('click', initExam);
        
    </script>
</body>
</html>
